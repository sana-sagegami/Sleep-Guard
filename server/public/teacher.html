<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ClassGuard - æ•™å¸«ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f7;
        padding: 40px 20px;
      }

      #dashboard {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 32px;
        color: #1d1d1f;
        margin-bottom: 30px;
        text-align: center;
      }

      button {
        width: 100%;
        padding: 16px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 12px;
        background: #007aff;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 30px;
      }

      button:hover {
        background: #0051d5;
        transform: translateY(-2px);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        background: #8e8e93;
        cursor: not-allowed;
        transform: none;
      }

      button:disabled:hover {
        background: #8e8e93;
        transform: none;
      }

      #qrCode {
        text-align: center;
        padding: 30px;
        background: #f9f9f9;
        border-radius: 12px;
        margin-bottom: 30px;
      }

      #qrCode:empty {
        display: none;
      }

      #studentList {
        padding: 20px;
        background: #f9f9f9;
        border-radius: 12px;
      }

      .connection-status {
        text-align: center;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        font-weight: 600;
      }

      .connection-status.connected {
        background: rgba(52, 199, 89, 0.1);
        color: #34c759;
      }

      .connection-status.disconnected {
        background: rgba(255, 59, 48, 0.1);
        color: #ff3b30;
      }
    </style>
  </head>
  <body>
    <div id="dashboard">
      <h1>ğŸ‘ï¸ ClassGuard æ•™å¸«ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

      <!-- æ¥ç¶šçŠ¶æ…‹è¡¨ç¤º -->
      <div id="connectionStatusDisplay" class="connection-status disconnected">
        âšª æ¥ç¶šç¢ºèªä¸­...
      </div>

      <button id="startClassBtn">ğŸ“š æˆæ¥­é–‹å§‹</button>
      <div id="qrCode"></div>
      <div id="studentList"></div>
    </div>

    <script>
        console.log("ğŸ”§ æ•™å¸«ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–é–‹å§‹");

        // Socket.ioæ¥ç¶šï¼ˆä¿®æ­£ç‰ˆï¼‰
        let socket = null;
        let currentSessionId = null;
        let connectionAttempts = 0;
        const maxConnectionAttempts = 5;

        // æ¥ç¶šã‚’è©¦è¡Œ
        function connectToServer() {
            connectionAttempts++;
            console.log(`ğŸ”Œ Socket.ioæ¥ç¶šè©¦è¡Œ (${connectionAttempts}/${maxConnectionAttempts})`);

            try {
                socket = io('/teacher', {
                    transports: ['polling'],
                    upgrade: false,
                    forceNew: true,
                    reconnection: true,
                    reconnectionDelay: 2000,
                    reconnectionAttempts: 3,
                    timeout: 10000
                });

                // æ¥ç¶šæˆåŠŸ
                socket.on('connect', () => {
                    console.log("âœ… Socket.ioæ¥ç¶šæˆåŠŸ");
                    console.log("ğŸ“¡ Socket ID:", socket.id);
                    console.log("ğŸ“¡ Transport:", socket.io.engine.transport.name);
                    
                    connectionAttempts = 0; // ãƒªã‚»ãƒƒãƒˆ
                    updateConnectionStatus(true);
                });

                // æ¥ç¶šã‚¨ãƒ©ãƒ¼
                socket.on('connect_error', (error) => {
                    console.error("âŒ Socket.ioæ¥ç¶šã‚¨ãƒ©ãƒ¼:", error.message);
                    console.error("ğŸ“Š ã‚¨ãƒ©ãƒ¼è©³ç´°:", error);
                    
                    updateConnectionStatus(false);
                    
                    // æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸã‚‰åœæ­¢
                    if (connectionAttempts >= maxConnectionAttempts) {
                        console.error("âŒ æœ€å¤§æ¥ç¶šè©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸ");
                        showFallbackMode();
                        return;
                    }
                    
                    // å†è©¦è¡Œ
                    setTimeout(() => {
                        console.log("ğŸ”„ å†æ¥ç¶šã‚’è©¦è¡Œã—ã¾ã™...");
                        connectToServer();
                    }, 3000);
                });

                // åˆ‡æ–­
                socket.on('disconnect', (reason) => {
                    console.log("âŒ Socket.ioåˆ‡æ–­:", reason);
                    updateConnectionStatus(false);
                });

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸ
                socket.on('session-created', (sessionId) => {
                    console.log("ğŸ“š ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸ:", sessionId);
                    currentSessionId = sessionId;
                    
                    // è¡¨ç¤ºã‚’æ›´æ–°
                    showSessionInfo(sessionId);
                    generateQRCode(sessionId);
                });

                // çµ±è¨ˆæ›´æ–°
                socket.on('update', (stats) => {
                    console.log("ğŸ“Š çµ±è¨ˆæ›´æ–°å—ä¿¡:", stats);
                    updateStudentList(stats);
                });

                // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                socket.on('error', (error) => {
                    console.error("âŒ Socket.ioã‚¨ãƒ©ãƒ¼:", error);
                });

            } catch (err) {
                console.error("âŒ Socket.ioåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err);
                updateConnectionStatus(false);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼ˆSocket.ioæ¥ç¶šå¤±æ•—æ™‚ï¼‰
        function showFallbackMode() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `
                <h1>ğŸ‘ï¸ ClassGuard æ•™å¸«ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0;">
                    <h3 style="color: #856404; margin-bottom: 10px;">âš ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</h3>
                    <p style="color: #856404; margin: 0;">
                        Socket.ioã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                        æ‰‹å‹•ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚
                    </p>
                </div>
                <button onclick="startManualSession()" style="background: #28a745;">
                    ğŸ“š æ‰‹å‹•ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
                </button>
                <div id="manualSession" style="display: none; margin-top: 20px;"></div>
            `;
        }

        // æ‰‹å‹•ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
        function startManualSession() {
            const sessionId = 'cls_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            document.getElementById('manualSession').innerHTML = `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px;">
                    <h3 style="color: #155724; margin-bottom: 10px;">âœ… æ‰‹å‹•ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</h3>
                    <p style="color: #155724; font-size: 18px; font-weight: bold;">
                        ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${sessionId}
                    </p>
                    <p style="color: #155724; margin-top: 10px;">
                        ã“ã®IDã‚’Chromeæ‹¡å¼µæ©Ÿèƒ½ã®è¨­å®šã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                    </p>
                </div>
            `;
            document.getElementById('manualSession').style.display = 'block';
            
            console.log("ğŸ“š æ‰‹å‹•ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹:", sessionId);
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
        function showSessionInfo(sessionId) {
            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #155724; margin-bottom: 10px;">âœ… æˆæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</h3>
                    <p style="color: #155724; font-size: 18px; font-weight: bold;">
                        ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${sessionId}
                    </p>
                    <div id="qr-code-area" style="margin-top: 15px;"></div>
                </div>
            `;
        }

        // æˆæ¥­é–‹å§‹
        function startClass() {
            if (!socket || !socket.connected) {
                console.warn("âš ï¸ Socket.ioæœªæ¥ç¶š - æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹");
                startManualSession();
                return;
            }

            console.log("ğŸ“š æˆæ¥­é–‹å§‹è¦æ±‚é€ä¿¡");
            
            socket.emit('start', (response) => {
                console.log("ğŸ“š æˆæ¥­é–‹å§‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", response);
                
                if (response && response.sessionId) {
                    currentSessionId = response.sessionId;
                    console.log("âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æˆåŠŸ:", currentSessionId);
                } else {
                    console.error("âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å¤±æ•—");
                    startManualSession();
                }
            });
        }

        // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        function generateQRCode(sessionId) {
            const qrArea = document.getElementById('qr-code-area');
            if (!qrArea) return;

            try {
                if (typeof QRCode !== 'undefined') {
                    new QRCode(qrArea, {
                        text: sessionId,
                        width: 200,
                        height: 200,
                    });
                    console.log("âœ… QRã‚³ãƒ¼ãƒ‰ç”ŸæˆæˆåŠŸ");
                } else {
                    qrArea.innerHTML = `
                        <p style="color: #856404;">QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                        <p style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                            ${sessionId}
                        </p>
                    `;
                    console.warn("âš ï¸ QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨ã§ãã¾ã›ã‚“");
                }
            } catch (err) {
                console.error("âŒ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", err);
            }
        }

        // æ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°
        function updateConnectionStatus(connected) {
            const statusDisplay = document.getElementById('connectionStatusDisplay');
            const startBtn = document.getElementById('startClassBtn');

            if (connected) {
                statusDisplay.textContent = "âœ… ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­";
                statusDisplay.className = "connection-status connected";
                if (startBtn) startBtn.disabled = false;
            } else {
                statusDisplay.textContent = "âŒ ã‚µãƒ¼ãƒãƒ¼æœªæ¥ç¶š";
                statusDisplay.className = "connection-status disconnected";
                if (startBtn) startBtn.disabled = true;
            }
        }

        // å­¦ç”Ÿãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateStudentList(stats) {
            const listContainer = document.getElementById('studentList');
            if (!listContainer) return;

            listContainer.innerHTML = `
                <h3>ğŸ“Š ç¾åœ¨ã®çŠ¶æ³</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${stats.totalStudents || 0}</div>
                        <div style="color: #1976d2;">å‚åŠ è€…æ•°</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${stats.awakeCount || 0}</div>
                        <div style="color: #388e3c;">èµ·ãã¦ã„ã‚‹</div>
                    </div>
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #d32f2f;">${stats.sleepingCount || 0}</div>
                        <div style="color: #d32f2f;">å±…çœ ã‚Šä¸­</div>
                    </div>
                </div>
            `;
        }

        // æˆæ¥­é–‹å§‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('startClassBtn').addEventListener('click', startClass);

        // åˆæœŸåŒ–
        console.log("ğŸš€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–å®Œäº†");
        updateConnectionStatus(false);

        // Socket.ioæ¥ç¶šé–‹å§‹
        setTimeout(() => {
            connectToServer();
        }, 1000);
    </script>
</body>
</html>