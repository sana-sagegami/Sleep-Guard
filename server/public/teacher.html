<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ClassGuard - 教師用ダッシュボード</title>
    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f7;
        padding: 40px 20px;
      }

      #dashboard {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 32px;
        color: #1d1d1f;
        margin-bottom: 30px;
        text-align: center;
      }

      button {
        width: 100%;
        padding: 16px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 12px;
        background: #007aff;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 30px;
      }

      button:hover {
        background: #0051d5;
        transform: translateY(-2px);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        background: #8e8e93;
        cursor: not-allowed;
        transform: none;
      }

      button:disabled:hover {
        background: #8e8e93;
        transform: none;
      }

      #qrCode {
        text-align: center;
        padding: 30px;
        background: #f9f9f9;
        border-radius: 12px;
        margin-bottom: 30px;
      }

      #qrCode:empty {
        display: none;
      }

      #studentList {
        padding: 20px;
        background: #f9f9f9;
        border-radius: 12px;
      }

      .connection-status {
        text-align: center;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        font-weight: 600;
      }

      .connection-status.connected {
        background: rgba(52, 199, 89, 0.1);
        color: #34c759;
      }

      .connection-status.disconnected {
        background: rgba(255, 59, 48, 0.1);
        color: #ff3b30;
      }
    </style>
  </head>
  <body>
    <div id="dashboard">
      <h1>👁️ ClassGuard 教師用ダッシュボード</h1>

      <!-- 接続状態表示 -->
      <div id="connectionStatusDisplay" class="connection-status disconnected">
        ⚪ 接続確認中...
      </div>

      <button id="startClassBtn">📚 授業開始</button>
      <div id="qrCode"></div>
      <div id="studentList"></div>
    </div>

    <script>
      console.log("🔧 教師用ダッシュボード初期化開始");

      // Socket.io接続（修正版）
      let socket = null;
      let currentSessionId = null;
      let connectionAttempts = 0;
      const maxConnectionAttempts = 5;
      let isClassActive = false; // 授業状態フラグ

      // UIを授業開始状態に切替
      function setClassStarted(sessionId) {
        isClassActive = true;
        currentSessionId = sessionId;
        const startBtn = document.getElementById("startClassBtn");
        startBtn.textContent = "⏹️ 授業終了";
        startBtn.disabled = false;
        showSessionInfo(sessionId);
        generateQRCode(sessionId);
      }

      // 授業終了処理
      function endClass() {
        if (!isClassActive) return;

        // Socket経由で開始されていればサーバーに通知
        if (socket && socket.connected && currentSessionId) {
          console.log("📴 授業終了要求送信:", currentSessionId);
          socket.emit("end", currentSessionId);
        }

        // UIをリセット
        resetUI();
      }

      // UIをリセット
      function resetUI() {
        isClassActive = false;
        currentSessionId = null;
        const startBtn = document.getElementById("startClassBtn");
        startBtn.textContent = "📚 授業開始";
        startBtn.disabled = false;
        document.getElementById("qrCode").innerHTML = "";
        document.getElementById("studentList").innerHTML = "";
        console.log("✅ UI リセット完了");
      }

      // 接続を試行
      function connectToServer() {
        connectionAttempts++;
        console.log(
          `🔌 Socket.io接続試行 (${connectionAttempts}/${maxConnectionAttempts})`
        );
        console.log("🌐 現在のURL:", window.location.href);
        console.log("🌐 ホスト:", window.location.host);

        // サーバー接続確認
        fetch("/socket.io/health")
          .then((res) => res.json())
          .then((data) => {
            console.log("✅ サーバーヘルスチェック成功:", data);
          })
          .catch((err) => {
            console.error("❌ サーバーヘルスチェック失敗:", err);
          });

        try {
          socket = io("/teacher", {
            transports: ["polling"],
            upgrade: false,
            forceNew: true,
            reconnection: true,
            reconnectionDelay: 2000,
            reconnectionAttempts: 3,
            timeout: 10000,
          });

          // 接続成功
          socket.on("connect", () => {
            console.log("✅ Socket.io接続成功");
            console.log("📡 Socket ID:", socket.id);
            console.log("📡 Transport:", socket.io.engine.transport.name);

            connectionAttempts = 0; // リセット
            updateConnectionStatus(true);
            bindSessionEndedHandler(); // セッション終了ハンドラをバインド
          });

          // 接続エラー
          socket.on("connect_error", (error) => {
            console.error("❌ Socket.io接続エラー:", error.message);
            console.error("📊 エラー詳細:", error);

            updateConnectionStatus(false);

            // 最大試行回数に達したら停止
            if (connectionAttempts >= maxConnectionAttempts) {
              console.error("❌ 最大接続試行回数に達しました");
              showFallbackMode();
              return;
            }

            // 再試行
            setTimeout(() => {
              console.log("🔄 再接続を試行します...");
              connectToServer();
            }, 3000);
          });

          // 切断
          socket.on("disconnect", (reason) => {
            console.log("❌ Socket.io切断:", reason);
            updateConnectionStatus(false);
          });

          // セッション作成成功
          socket.on("session-created", (sessionId) => {
            console.log("📚 セッション作成成功:", sessionId);
            setClassStarted(sessionId); // 授業開始状態に切り替え
          });

          // 統計更新
          socket.on("update", (stats) => {
            console.log("📊 統計更新受信:", stats);
            updateStudentList(stats);
          });

          // エラーハンドリング
          socket.on("error", (error) => {
            console.error("❌ Socket.ioエラー:", error);
          });
        } catch (err) {
          console.error("❌ Socket.io初期化エラー:", err);
          updateConnectionStatus(false);
        }
      }

      // サーバーからセッション終了通知を受けたらUIをリセット
      function bindSessionEndedHandler() {
        if (!socket) return;
        socket.on("session-ended", () => {
          console.log("📚 サーバー通知: セッション終了");
          resetUI();
        });
      }

      // フォールバックモード（Socket.io接続失敗時）
      function showFallbackMode() {
        const dashboard = document.getElementById("dashboard");
        dashboard.innerHTML = `
                <h1>👁️ ClassGuard 教師用ダッシュボード</h1>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0;">
                    <h3 style="color: #856404; margin-bottom: 10px;">⚠️ リアルタイム通信が利用できません</h3>
                    <p style="color: #856404; margin: 0;">
                        Socket.ioサーバーに接続できませんでした。<br>
                        手動でセッションを開始します。
                    </p>
                </div>
                <button onclick="startManualSession()" style="background: #28a745;">
                    📚 手動セッション開始
                </button>
                <div id="manualSession" style="display: none; margin-top: 20px;"></div>
            `;
      }

      // 手動セッション開始
      function startManualSession() {
        const sessionId =
          "cls_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);

        const qrContainer = document.getElementById("qrCode");
        
        if (!qrContainer) {
          console.error("❌ qrCode要素が見つかりません");
          alert("エラー: QRコード表示エリアが見つかりません");
          return null;
        }

        qrContainer.innerHTML = `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px;">
                    <h3 style="color: #155724; margin-bottom: 10px;">✅ 手動セッション開始</h3>
                    <p style="color: #155724; font-size: 18px; font-weight: bold;">
                        セッションID: ${sessionId}
                    </p>
                    <p style="color: #155724; margin-top: 10px;">
                        このIDをChrome拡張機能の設定に入力してください。
                    </p>
                </div>
            `;

        console.log("📚 手動セッション開始:", sessionId);
        return sessionId; // セッションIDを返す
      }

      // セッション情報を表示
      function showSessionInfo(sessionId) {
        const qrContainer = document.getElementById("qrCode");
        const joinUrl = `${window.location.origin}?session=${sessionId}`;

        qrContainer.innerHTML = `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #155724; margin-bottom: 10px;">✅ 授業セッション開始</h3>
                    <p style="color: #155724; font-size: 18px; font-weight: bold;">
                        セッションID: <span id="session-id-text">${sessionId}</span>
                        <button onclick="copySessionId('${sessionId}')" style="margin-left: 10px; padding: 5px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            📋 コピー
                        </button>
                    </p>
                    <p style="color: #666; font-size: 12px; margin-top: 10px;">
                        💡 セッションIDをコピーするだけで自動参加できます
                    </p>
                    <div id="qr-code-area" style="margin-top: 15px;"></div>
                </div>
            `;
      }

      // セッションIDをコピー
      function copySessionId(sessionId) {
        navigator.clipboard
          .writeText(sessionId)
          .then(() => {
            alert(
              "✅ セッションIDをコピーしました！\n学生に共有してください。"
            );
          })
          .catch((err) => {
            console.error("コピー失敗:", err);
          });
      }

      // 授業開始
      function startClass() {
        // ボタンは開始/終了を兼ねる
        const startBtn = document.getElementById("startClassBtn");

        if (isClassActive) {
          // 既に授業中 → 終了
          endClass();
          return;
        }

        // 授業開始処理
        if (!socket || !socket.connected) {
          console.warn("⚠️ Socket.io未接続 - 手動モードで開始");
          const sessionId = startManualSession();
          setClassStarted(sessionId);
          return;
        }

        startBtn.disabled = true;
        console.log("📚 授業開始要求送信");

        socket.emit("start", (response) => {
          console.log("📚 授業開始レスポンス:", response);
          startBtn.disabled = false;

          if (response && response.sessionId) {
            setClassStarted(response.sessionId);
          } else {
            console.error("❌ セッション開始失敗 - 手動モードにフォールバック");
            const sessionId = startManualSession();
            setClassStarted(sessionId);
          }
        });
      }

      // QRコード生成
      function generateQRCode(sessionId) {
        const qrArea = document.getElementById("qr-code-area");
        if (!qrArea) return;

        try {
          if (typeof QRCode !== "undefined") {
            new QRCode(qrArea, {
              text: sessionId,
              width: 200,
              height: 200,
            });
            console.log("✅ QRコード生成成功");
          } else {
            qrArea.innerHTML = `
                        <p style="color: #856404;">QRコード生成に失敗しました</p>
                        <p style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                            ${sessionId}
                        </p>
                    `;
            console.warn("⚠️ QRCodeライブラリが利用できません");
          }
        } catch (err) {
          console.error("❌ QRコード生成エラー:", err);
        }
      }

      // 接続状態を更新
      function updateConnectionStatus(connected) {
        const statusDisplay = document.getElementById(
          "connectionStatusDisplay"
        );
        const startBtn = document.getElementById("startClassBtn");

        if (!statusDisplay) {
          console.warn("⚠️ connectionStatusDisplay要素が見つかりません");
          return;
        }

        if (connected) {
          statusDisplay.textContent = "✅ サーバーに接続中";
          statusDisplay.className = "connection-status connected";
          if (startBtn) startBtn.disabled = false;
        } else {
          statusDisplay.textContent = "❌ サーバー未接続";
          statusDisplay.className = "connection-status disconnected";
          if (startBtn) startBtn.disabled = true;
        }
      }

      // 学生リストを更新
      function updateStudentList(data) {
        const listContainer = document.getElementById("studentList");
        if (!listContainer) return;

        console.log("🔄 学生リスト更新:", data);
        console.log("   データ型:", typeof data);
        console.log("   data.stats:", data.stats);
        console.log("   data.students:", data.students);

        // データ構造を確認
        const stats = data.stats || data;
        const students = data.students || {};

        console.log("   解析後 stats:", stats);
        console.log("   解析後 students:", students);
        console.log("   生徒数:", Object.keys(students).length);

        const now = new Date();
        const updateTime = now.toLocaleTimeString("ja-JP");

        listContainer.innerHTML = `
                <h3>📊 現在の状況</h3>
                <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                    最終更新: ${updateTime}
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${
                          stats.totalStudents || 0
                        }</div>
                        <div style="color: #1976d2;">参加者数</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${
                          stats.awakeCount || 0
                        }</div>
                        <div style="color: #388e3c;">起きている</div>
                    </div>
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #d32f2f;">${
                          stats.sleepingCount || 0
                        }</div>
                        <div style="color: #d32f2f;">居眠り中</div>
                    </div>
                </div>
                ${
                  Object.keys(students).length > 0
                    ? `
                    <div style="margin-top: 20px;">
                        <h4>学生一覧</h4>
                        ${Object.values(students)
                          .map((student, index) => {
                            const lastUpdate = new Date(
                              student.lastUpdate
                            ).toLocaleTimeString("ja-JP");
                            return `
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>学生 ${index + 1}</strong>
                                    <span style="font-size: 11px; color: #999; margin-left: 8px;">${student.id.substr(
                                      0,
                                      12
                                    )}...</span>
                                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                        最終更新: ${lastUpdate}
                                    </div>
                                </div>
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${
                                  student.status === "sleeping"
                                    ? "#ffebee"
                                    : "#e8f5e9"
                                }; color: ${
                              student.status === "sleeping"
                                ? "#d32f2f"
                                : "#388e3c"
                            };">
                                    ${
                                      student.status === "sleeping"
                                        ? "😴 居眠り"
                                        : "😊 起きている"
                                    }
                                </span>
                            </div>
                        `;
                          })
                          .join("")}
                    </div>
                `
                    : `
                    <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666;">
                        👥 まだ学生が参加していません
                    </div>
                `
                }
            `;
      }

      // 授業開始ボタンのイベント
      document
        .getElementById("startClassBtn")
        .addEventListener("click", startClass);
      document
        .getElementById("startClassBtn")
        .addEventListener("click", startClass);

      // 接続成立後に追加ハンドラをバインド
      // （connectToServer 内の socket.on('connect') の直後で bindSessionEndedHandler() を呼ぶことを推奨）
      // もし既に socket を作ったあとなら明示的にバインド
      setTimeout(() => {
        if (socket) bindSessionEndedHandler();
      }, 1500);

      // 初期化
      console.log("🚀 ダッシュボード初期化完了");
      updateConnectionStatus(false);

      // Socket.io接続開始
      setTimeout(() => {
        connectToServer();
      }, 1000);
    </script>
  </body>
</html>
